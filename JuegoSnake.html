<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Snake Toon - 1000 Levels</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #FFC107; --accent: #00E676; --bg: #B2EBF2;
            --ui-bg: #FFFFFF; --text: #37474F;
            --font: 'Fredoka One', cursive, sans-serif;
            --shadow-hard: 4px 4px 0px rgba(0,0,0,0.2);
        }
        
        * { box-sizing: border-box; user-select: none; touch-action: none; -webkit-tap-highlight-color: transparent; font-family: var(--font); }
        
        body {
            margin: 0; padding: 0; background-color: var(--bg);
            background-image: radial-gradient(circle at center, rgba(255,255,255,0.6) 2px, transparent 2px);
            background-size: 30px 30px; animation: bgScroll 20s linear infinite;
            color: var(--text); overflow: hidden; height: 100vh; height: 100dvh;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: background 1s ease;
        }
        @keyframes bgScroll { from { background-position: 0 0; } to { background-position: 60px 60px; } }
        @keyframes pulseBtn { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.03); } }

        /* LOADER */
        #screen-loading { position: fixed; top:0;left:0;width:100%;height:100%; background:var(--bg); z-index:99; display:flex; flex-direction:column; align-items:center; justify-content:center; transition:opacity 0.5s; }
        .loader-snake { width: 70px; height: 70px; background: var(--accent); border-radius: 50%; border: 5px solid #fff; box-shadow: var(--shadow-hard); animation: jelly 0.6s ease infinite; position: relative; }
        @keyframes jelly { 0%,100%{transform:scale(1,1)} 25%{transform:scale(0.9,1.15)} 50%{transform:scale(1.15,0.9)} 75%{transform:scale(0.95,1.05)} }

        /* UI */
        #game-wrapper { position: relative; width: 100%; max-width: 600px; height: 100%; display: flex; flex-direction: column; align-items: center; padding-top: 10px; }
        
        .hud-container { width: 95%; max-width: 500px; display: flex; justify-content: space-between; padding: 5px 0; z-index: 5; margin-bottom: 5px; }
        .stat-box { background: var(--ui-bg); padding: 5px 10px; border-radius: 15px; border: 3px solid var(--text); text-align: center; box-shadow: var(--shadow-hard); transform: rotate(-2deg); min-width: 75px;}
        .stat-box:nth-child(2) { transform: rotate(2deg); }
        .stat-label { font-size: 0.6rem; color: #888; letter-spacing: 1px; } 
        .stat-val { font-size: 1.1rem; -webkit-text-stroke: 1px var(--text); color: var(--text); }
        .money-val { color: #FFD700; -webkit-text-stroke: 1.5px black; }
        .progress-bar { width: 95%; height: 18px; background: #fff; border-radius: 10px; overflow: hidden; border: 3px solid var(--text); box-shadow: var(--shadow-hard); margin-bottom: 10px; flex-shrink: 0;}
        .progress-fill { height: 100%; background: repeating-linear-gradient(-45deg, var(--accent), var(--accent) 10px, #69F0AE 10px, #69F0AE 20px); width: 0%; transition: width 0.3s; }

        canvas { 
            background: #E1F5FE; border: 5px solid var(--text); border-radius: 20px; 
            box-shadow: var(--shadow-hard); width: 95%; aspect-ratio: 1/1; max-width: 500px; max-height: 45vh; 
            z-index: 1; cursor: crosshair; touch-action: none; transition: border-color 1s, box-shadow 1s, background 1s;
        }

        /* CONTROLS */
        .controls-mobile { display: none; position: relative; width: 180px; height: 180px; margin-top: auto; margin-bottom: 30px; flex-shrink: 0; }
        @media (hover: none) and (pointer: coarse) { .controls-mobile { display: flex; } }
        @media (max-height: 700px) { .controls-mobile { transform: scale(0.8); margin-bottom: 10px; } canvas { max-height: 40vh;} }
        .dpad-btn { position: absolute; width: 60px; height: 60px; background: var(--ui-bg); border: 3px solid var(--text); border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 30px; box-shadow: 4px 4px 0px rgba(0,0,0,0.2); transition: 0.05s; color: var(--text); }
        .dpad-btn:active { background: var(--accent); color: #fff; transform: translate(4px,4px); box-shadow: none; }
        .u { top: 0; left: 60px; border-radius: 15px 15px 5px 5px; } .d { bottom: 0; left: 60px; border-radius: 5px 5px 15px 15px; } .l { top: 60px; left: 0; border-radius: 15px 5px 5px 15px; } .r { top: 60px; right: 0; border-radius: 5px 15px 15px 5px; }
        .corner-btn { position: absolute; top: 15px; right: 15px; width: 45px; height: 45px; background: var(--ui-bg); border: 3px solid var(--text); border-radius: 50%; display:flex; align-items:center; justify-content:center; font-size:20px; box-shadow: var(--shadow-hard); z-index:50; cursor: pointer; color: var(--text); }
        .corner-btn:active { transform: translate(3px,3px); box-shadow:none; }

        /* SCREENS */
        .screen { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(178, 235, 242, 0.95); backdrop-filter: blur(8px); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 20; transition: opacity 0.3s; }
        .hidden { opacity:0; pointer-events:none; display:none !important;}
        h1 { font-size: 4rem; margin: 0 0 20px 0; color: var(--accent); -webkit-text-stroke: 3px var(--text); text-shadow: 4px 4px 0px rgba(0,0,0,0.15); text-align: center; line-height: 0.9; animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0) rotate(-3deg); } 50% { transform: translateY(-8px) rotate(-3deg); } }

        .btn { background: var(--primary); border: 4px solid var(--text); padding: 12px 30px; color: var(--text); font-size: 1.4rem; border-radius: 30px; margin: 8px; cursor: pointer; box-shadow: var(--shadow-hard); text-transform: uppercase; width: 80%; max-width: 300px; transition: all 0.1s; animation: pulseBtn 2s infinite ease-in-out; }
        .btn:active { transform: translate(4px,4px) scale(1) !important; box-shadow: none !important; animation: none; }
        .btn-sec { background: var(--ui-bg); animation-delay: 0.5s; }
        .btn-shop { background: #FF4081; color: white; -webkit-text-stroke: 1px var(--text); animation-delay: 1s; }
        .btn-map { background: #00E676; color: white; -webkit-text-stroke: 1px var(--text); animation-delay: 0.2s; }

        /* MENU ANIMATION */
        .menu-mascot { width: 90px; height: 90px; background: var(--accent); border-radius: 50%; border: 5px solid #fff; box-shadow: var(--shadow-hard); margin: 10px auto; animation: jelly 2s infinite; position: relative; z-index: 10; }
        .menu-mascot::after { content: '‚Ä¢‚Ä¢'; position: absolute; color: white; font-size: 45px; top: 5px; left: 28px; transform: rotate(90deg); }
        .credits-text { font-size: 1rem; color: var(--text); margin-bottom: 15px; margin-top: 5px; font-weight: bold; letter-spacing: 1px; opacity: 0.8; }

        /* SHOP & MAP */
        .shop-wrapper { width: 95%; max-width: 500px; height: 60vh; background: #FFF59D; border-radius: 20px; padding: 10px; border: 4px solid var(--text); box-shadow: var(--shadow-hard); display: flex; flex-direction: column; }
        .shop-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; overflow-y: auto; padding: 5px 5px 50px 5px; flex: 1; touch-action: pan-y !important; -webkit-overflow-scrolling: touch; }
        .map-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; overflow-y: auto; padding: 20px 10px 60px 10px; flex: 1; touch-action: pan-y !important; -webkit-overflow-scrolling: touch; }
        .shop-grid *, .map-grid * { touch-action: pan-y !important; }

        .level-btn { aspect-ratio: 1/1; background: var(--ui-bg); border: 3px solid var(--text); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; color: var(--text); font-weight: bold; box-shadow: 3px 3px 0px rgba(0,0,0,0.15); cursor: pointer; position: relative; transition: transform 0.1s; }
        .level-btn:active { transform: scale(0.9); box-shadow: none; }
        .level-btn.locked { background: #CFD8DC; color: #90A4AE; border-color: #90A4AE; pointer-events: none; }
        .level-btn.current { background: var(--primary); color: white; -webkit-text-stroke: 1px var(--text); animation: pulseBtn 1s infinite alternate; border-color: #FF6F00; font-size: 1.4rem; border-width: 4px; }

        .skin-card { background: var(--ui-bg); border: 3px solid var(--text); border-radius: 12px; padding: 10px; display: flex; flex-direction: column; align-items: center; box-shadow: 2px 2px 0px rgba(0,0,0,0.15); min-height: 110px; cursor: pointer; position:relative; }
        .skin-card:active { transform: scale(0.95); }
        .skin-preview-icon { width: 45px; height: 45px; border-radius: 50%; margin-bottom: 8px; border: 2px solid var(--text); box-shadow: inset 0 0 5px rgba(0,0,0,0.1); }
        .owned .skin-badge { display: block; position: absolute; top: 5px; right: 5px; background: #00E676; color: white; font-size: 0.6rem; padding: 2px 6px; border-radius: 10px; border: 1px solid #000; }

        /* PREVIEW */
        #preview-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); z-index: 60; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #preview-canvas { width: 250px; height: 250px; background: #E1F5FE; border-radius: 20px; border: 4px solid var(--text); box-shadow: var(--shadow-hard); margin-bottom: 20px; }
        .preview-info { text-align: center; color: white; margin-bottom: 20px; }
        .preview-title { font-size: 2rem; margin: 0; color: var(--primary); -webkit-text-stroke: 1.5px var(--text); }
        .preview-price { font-size: 1.6rem; color: #FFD700; margin: 10px 0; -webkit-text-stroke: 1px var(--text); font-weight:bold;}
        
        #env-indicator { position: absolute; top: 10px; left: 15px; font-size: 0.8rem; background: rgba(255,255,255,0.8); padding: 5px 10px; border-radius: 10px; border: 2px solid var(--text); z-index: 4; font-weight: bold; display: none; }

        /* --- AD STYLES --- */
        #screen-ad {
            background: #000 !important;
            z-index: 999;
        }
        .ad-wrapper {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        #ad-video {
            width: 100%;
            max-height: 70vh;
            object-fit: contain;
            background: #000;
            cursor: pointer; /* Indica que es clicable */
        }
        .ad-ui-bottom {
            position: absolute;
            bottom: 40px;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0 20px;
            pointer-events: none;
        }
        .skip-btn {
            pointer-events: auto;
            background: rgba(255,255,255,0.2);
            color: #fff;
            border: 2px solid #fff;
            padding: 12px 30px;
            border-radius: 30px;
            font-size: 1rem;
            text-transform: uppercase;
            cursor: not-allowed;
            transition: all 0.3s;
            font-family: var(--font);
        }
        .skip-btn.active {
            background: var(--accent);
            border-color: var(--text);
            color: var(--text);
            cursor: pointer;
            box-shadow: var(--shadow-hard);
            transform: scale(1.1);
        }
        .ad-timer-corner {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 3px solid #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: bold;
            font-size: 1.2rem;
            background: rgba(0,0,0,0.5);
        }
        /* Mensaje de "Visitar sitio" sutil */
        .ad-hint {
            color: #fff;
            font-size: 0.8rem;
            margin-top: 10px;
            animation: pulseBtn 1s infinite;
        }
    </style>
</head>
<body>

<div id="screen-loading">
    <div class="loader-snake"></div>
    <h1>TOON<br>SNAKE</h1>
    <p>Generando 1000 Niveles...</p>
</div>

<div id="screen-ad" class="screen hidden">
    <div class="ad-wrapper">
        <div class="ad-timer-corner" id="ad-countdown-display">5</div>
        <video id="ad-video" playsinline webkit-playsinline onclick="Ads.clickAd()"></video>
        <div class="ad-hint">TOCA EL VIDEO PARA M√ÅS INFO</div>
        
        <div class="ad-ui-bottom">
            <button id="btn-skip" class="skip-btn" onclick="Ads.skip()">Espera 5s...</button>
        </div>
    </div>
</div>

<div id="preview-overlay" class="hidden">
    <canvas id="preview-canvas" width="300" height="300"></canvas>
    <div class="preview-info">
        <h2 class="preview-title" id="prev-name">Skin</h2>
        <p class="preview-desc" id="prev-desc" style="color:#eee">Efectos</p>
        <div class="preview-price" id="prev-price">$0</div>
    </div>
    <button class="btn" id="btn-buy-action" onclick="shop.confirmAction()">COMPRAR</button>
    <button class="btn btn-sec" onclick="shop.closePreview()" style="padding: 10px 30px;">CERRAR</button>
</div>

<div id="game-wrapper">
    <div id="env-indicator">MUNDO: TOON</div>
    <button class="corner-btn" onclick="game.togglePause()">II</button>
    <div class="hud-container">
        <div class="stat-box"><span class="stat-label">NIVEL</span><span class="stat-val" id="hud-level">1</span></div>
        <div class="stat-box"><span class="stat-label">PUNTOS</span><span class="stat-val" id="hud-score">0</span></div>
        <div class="stat-box"><span class="stat-label">BANCO</span><span class="stat-val money-val" id="hud-bank">0</span></div>
    </div>
    <div class="progress-bar"><div class="progress-fill" id="hud-prog"></div></div>
    <canvas id="gc"></canvas>
    <div class="controls-mobile">
        <div class="dpad-btn u" onclick="game.input(0,-1)">‚ñ≤</div>
        <div class="dpad-btn l" onclick="game.input(-1,0)">‚óÄ</div>
        <div class="dpad-btn r" onclick="game.input(1,0)">‚ñ∂</div>
        <div class="dpad-btn d" onclick="game.input(0,1)">‚ñº</div>
    </div>

    <div id="screen-menu" class="screen hidden">
        <div class="menu-mascot"></div>
        <h1>TOON<br>SNAKE</h1>
        <div class="credits-text">Creado por Juan Zamora</div>
        
        <div style="background:var(--ui-bg); padding:10px 25px; border-radius:15px; border:3px solid var(--text); box-shadow:var(--shadow-hard); transform:rotate(2deg); margin-bottom: 20px;">
            <p style="margin:5px; color:#FFD700; -webkit-text-stroke: 1px var(--text); font-size:1.5rem; font-weight:bold;">$ <span id="menu-money">0</span></p>
        </div>
        <button class="btn" onclick="game.startRun(game.data.maxLevel)">CONTINUAR</button>
        <button class="btn btn-map" onclick="map.open()">MAPA (1000 NIVELES)</button>
        <button class="btn btn-shop" onclick="shop.open()">TIENDA</button>
    </div>

    <div id="screen-map" class="screen hidden">
        <h2 style="font-size:2.5rem; color:var(--accent); -webkit-text-stroke:2px var(--text); margin-bottom:5px;">MUNDOS</h2>
        <p style="margin:0 0 10px 0; font-size:0.8rem; color:#666;">¬°Completa los 1000 niveles!</p>
        <div class="shop-wrapper"><div class="map-grid" id="map-container"></div></div>
        <button class="btn btn-sec" onclick="game.toMenu()" style="width:auto; margin-top:15px; padding: 10px 30px;">VOLVER</button>
    </div>

    <div id="screen-shop" class="screen hidden">
        <h2 style="font-size:2.5rem; color:var(--accent); -webkit-text-stroke:2px var(--text); margin-bottom:5px;">TIENDA</h2>
        <p style="margin:0 0 10px 0; font-size:0.8rem; color:#666;">Toca para ver efectos</p>
        <div class="shop-wrapper"><div class="shop-grid" id="shop-container"></div></div>
        <button class="btn btn-sec" onclick="game.toMenu()" style="width:auto; margin-top:15px; padding: 10px 30px;">VOLVER</button>
    </div>

    <div id="screen-over" class="screen hidden">
        <h2 style="font-size:4rem; color:#FF5252; -webkit-text-stroke:3px var(--text); transform:rotate(-5deg); margin-bottom:10px;">¬°OUCH!</h2>
        <h3 style="font-size:3rem; color:#FFD700; -webkit-text-stroke:2px var(--text); margin: 5px 0 25px 0;">+$<span id="over-earnings">0</span></h3>
        <button class="btn" onclick="game.restartLevel()">REINTENTAR</button>
        <button class="btn btn-map" style="background:#00E676;color:white;-webkit-text-stroke:1px var(--text)" onclick="map.open()">MAPA</button>
        <button class="btn btn-sec" onclick="game.toMenu()">MEN√ö</button>
    </div>

    <div id="screen-pause" class="screen hidden">
        <h2 style="font-size:3rem; color:var(--primary); -webkit-text-stroke:2px var(--text);">PAUSA</h2>
        <button class="btn" onclick="game.resume()">SEGUIR</button>
        <button class="btn btn-sec" onclick="game.toMenu()">SALIR</button>
    </div>
</div>

<script>
/* --- ADS SYSTEM --- */
const Ads = {
    // AQU√ç CONFIGURAS TUS VIDEOS Y TUS ENLACES
    videos: [
        { src: 'anuncio.mp4', url: 'https://www.facebook.com/reel/818844437624585/?app=fbl' },
        { src: 'anuncio2.mp4', url: 'https://www.facebook.com/reel/818844437624585/?app=fbl' },
        { src: 'anuncio3.mp4', url: 'https://www.facebook.com/reel/818844437624585/?app=fbl' }
    ],
    played: 0,
    interval: 10, // Anuncio cada 10 partidas
    timerVal: 5,
    timerInt: null,
    canSkip: false,
    currentUrl: '', // Almacena la URL del anuncio actual

    check() {
        this.played++;
        if(this.played % this.interval === 0) {
            this.show();
            return true; 
        }
        return false; 
    },

    show() {
        const v = document.getElementById('ad-video');
        
        // Seleccionar video y enlace random
        const adData = this.videos[Math.floor(Math.random() * this.videos.length)];
        
        v.src = adData.src;
        this.currentUrl = adData.url; // Guardamos la URL para el clic

        // Reset UI
        this.canSkip = false;
        this.timerVal = 5;
        const btn = document.getElementById('btn-skip');
        btn.classList.remove('active');
        btn.innerText = `Espera ${this.timerVal}s...`;
        document.getElementById('ad-countdown-display').innerText = this.timerVal;
        
        Game.showScreen('screen-ad');
        v.play().catch(e => console.log("Autoplay prevented", e));

        // Iniciar cuenta regresiva
        if(this.timerInt) clearInterval(this.timerInt);
        this.timerInt = setInterval(() => {
            this.timerVal--;
            document.getElementById('ad-countdown-display').innerText = this.timerVal;
            if(this.timerVal > 0) {
                btn.innerText = `Espera ${this.timerVal}s...`;
            } else {
                this.enableSkip();
            }
        }, 1000);
    },

    enableSkip() {
        clearInterval(this.timerInt);
        this.canSkip = true;
        const btn = document.getElementById('btn-skip');
        btn.classList.add('active');
        btn.innerText = "OMITIR ANUNCIO >";
        document.getElementById('ad-countdown-display').innerText = "X";
    },

    clickAd() {
        // Abre la URL guardada
        if(this.currentUrl) {
            window.open(this.currentUrl, '_blank');
        }
    },

    skip() {
        if(!this.canSkip) return;
        const v = document.getElementById('ad-video');
        v.pause();
        v.currentTime = 0;
        Game.showScreen('screen-over');
        Game.state = 'OVER';
    }
};

/* --- ENVIRONMENTS --- */
const Env = {
    current: 'toon', themes: ['toon', 'magma', 'neon', 'disco', 'glitch', 'ocean'],
    set(level) {
        const index = Math.floor((level - 1) / 5) % this.themes.length;
        this.current = this.themes[index]; this.applyCSS();
        document.getElementById('env-indicator').style.display='block';
        document.getElementById('env-indicator').innerText=`MUNDO: ${this.current.toUpperCase()}`;
    },
    applyCSS() {
        const b = document.body; const c = document.getElementById('gc');
        c.style.transform='none'; c.style.filter='none';
        if (this.current === 'toon') { b.style.background='radial-gradient(circle, #B2EBF2 0%, #80DEEA 100%)'; c.style.background='#E1F5FE'; c.style.borderColor='#37474F'; }
        else if (this.current === 'magma') { b.style.background='radial-gradient(circle, #FF5722 0%, #BF360C 100%)'; c.style.background='#3E2723'; c.style.borderColor='#FF3D00'; }
        else if (this.current === 'neon') { b.style.background='#121212'; c.style.background='#000'; c.style.borderColor='#00E676'; c.style.boxShadow='0 0 20px #00E676'; }
        else if (this.current === 'disco') { b.style.background='#311B92'; c.style.background='#000'; }
        else if (this.current === 'glitch') { b.style.background='#212121'; c.style.background='#000'; c.style.borderColor='#0f0'; }
        else if (this.current === 'ocean') { b.style.background='linear-gradient(180deg, #0288D1 0%, #01579B 100%)'; c.style.background='#E0F7FA'; c.style.borderColor='#0277BD'; }
    },
    applyFrameEffect(ctx, w, h, t) {
        if (this.current === 'magma') { const s=1+Math.sin(t/200)*0.02; ctx.translate(w/2,h/2); ctx.scale(s,s); ctx.translate(-w/2,-h/2); }
        else if (this.current === 'disco') { 
            const hue=(t/5)%360; document.body.style.backgroundColor=`hsl(${hue},60%,20%)`; document.getElementById('gc').style.borderColor=`hsl(${hue},100%,50%)`;
            const r=Math.sin(t/500)*0.05; ctx.translate(w/2,h/2); ctx.rotate(r); ctx.translate(-w/2,-h/2);
        }
        else if (this.current === 'glitch' && Math.random()>0.9) { ctx.translate((Math.random()-0.5)*10, (Math.random()-0.5)*10); }
        else if (this.current === 'ocean') { const r=Math.sin(t/1000)*0.03; ctx.translate(w/2,h/2); ctx.rotate(r); ctx.translate(-w/2,-h/2); }
    }
};

/* --- AUDIO --- */
const audioSys = {
    ctx: null,
    init() { try{ window.AudioContext=window.AudioContext||window.webkitAudioContext; this.ctx=new AudioContext(); }catch(e){} },
    resume() { if(this.ctx && this.ctx.state === 'suspended') this.ctx.resume(); },
    play(t) {
        if(!this.ctx) this.init(); this.resume(); if(!this.ctx) return;
        const o=this.ctx.createOscillator(), g=this.ctx.createGain(), now=this.ctx.currentTime;
        o.connect(g); g.connect(this.ctx.destination);
        if(t=='eat'){ o.type='sine'; o.frequency.setValueAtTime(400,now); o.frequency.linearRampToValueAtTime(800,now+0.1); g.gain.setValueAtTime(0.3,now); g.gain.linearRampToValueAtTime(0,now+0.15); o.start(now); o.stop(now+0.15); }
        if(t=='die'){ o.type='sawtooth'; o.frequency.setValueAtTime(300,now); o.frequency.linearRampToValueAtTime(50,now+0.6); g.gain.setValueAtTime(0.3,now); g.gain.linearRampToValueAtTime(0,now+0.6); o.start(now); o.stop(now+0.6); }
        if(t=='click'){ o.type='triangle'; o.frequency.setValueAtTime(600,now); g.gain.setValueAtTime(0.1,now); g.gain.linearRampToValueAtTime(0,now+0.05); o.start(now); o.stop(now+0.05); }
    }
};

/* --- SKINS (HIGH PRICES) --- */
const SKINS = [
    {id:'s1', n:'Cl√°sico', p:0, c:'#FF9800', e:'none', d:'La skin original.'},
    {id:'s2', n:'Azul', p:500, c:'#2196F3', e:'trail_bubble', d:'Deja burbujas.'},
    {id:'s3', n:'Rojo', p:1000, c:'#F44336', e:'trail_fire', d:'Deja llamas.'},
    {id:'s4', n:'Verde', p:1500, c:'#4CAF50', e:'trail_leaf', d:'Deja hojas.'},
    {id:'s5', n:'Morado', p:2000, c:'#9C27B0', e:'glow', d:'Brilla m√°gicamente.'},
    {id:'s6', n:'Lima', p:2500, c:'#CDDC39', e:'trail_slime', d:'Gotea slime.'},
    {id:'s7', n:'Rosa', p:3000, c:'#E91E63', e:'trail_heart', d:'Corazones.'},
    {id:'s8', n:'Gris', p:4000, c:'#9E9E9E', e:'heavy', d:'S√≥lido.'},
    {id:'s9', n:'Caf√©', p:5000, c:'#795548', e:'trail_dust', d:'Polvo.'},
    {id:'s10', n:'Negro', p:6000, c:'#212121', e:'shadow', d:'Sombra.'},
    {id:'s11', n:'Menta', p:8000, c:'#69F0AE', e:'sparkle', d:'Destellos.'},
    {id:'s12', n:'Cielo', p:10000, c:'#80D8FF', e:'cloud', d:'Nubes.'},
    {id:'s13', n:'Lavanda', p:12000, c:'#EA80FC', e:'scent', d:'Aroma.'},
    {id:'s14', n:'Crema', p:15000, c:'#FFF9C4', e:'melt', d:'Derretido.'},
    {id:'s15', n:'Coral', p:18000, c:'#FF8A80', e:'bubbles', d:'Burbujas.'},
    {id:'s16', n:'Abeja', p:20000, c:'#FFEB3B', e:'stripe_b', d:'Rayas abeja.'},
    {id:'s17', n:'Cebra', p:22000, c:'#FFFFFF', e:'stripe_b', d:'Rayas cebra.'},
    {id:'s18', n:'Tigre', p:25000, c:'#FF9800', e:'stripe_b', d:'Rayas tigre.'},
    {id:'s19', n:'Sand√≠a', p:28000, c:'#F44336', e:'seeds', d:'Semillas.'},
    {id:'s20', n:'Vaca', p:30000, c:'#FFFFFF', e:'spots', d:'Manchas.'},
    {id:'s21', n:'Ne√≥n Cyan', p:40000, c:'#00E5FF', e:'neon', d:'Luz ne√≥n.'},
    {id:'s22', n:'Ne√≥n Rosa', p:45000, c:'#FF4081', e:'neon', d:'Luz rosa.'},
    {id:'s23', n:'Ne√≥n Volt', p:50000, c:'#FFD600', e:'neon', d:'Voltaje.'},
    {id:'s24', n:'Fuego Real', p:60000, c:'#FF3D00', e:'fire_real', d:'Fuego real.'},
    {id:'s25', n:'Hielo', p:70000, c:'#B2EBF2', e:'ice_shard', d:'Hielo.'},
    {id:'s26', n:'T√≥xico', p:80000, c:'#76FF03', e:'acid', d:'√Åcido.'},
    {id:'s27', n:'Electro', p:90000, c:'#FFFF00', e:'zap', d:'Rayos.'},
    {id:'s28', n:'Magma', p:100000, c:'#BF360C', e:'magma', d:'Lava.'},
    {id:'s29', n:'Fantasma', p:120000, c:'#fff', e:'ghost', d:'Espectro.'},
    {id:'s30', n:'Sombra', p:140000, c:'#000', e:'darkness', d:'Oscuridad.'},
    {id:'s31', n:'Pixel', p:160000, c:'#4CAF50', e:'pixel', d:'8-bits.'},
    {id:'s32', n:'Glitch', p:180000, c:'#212121', e:'glitch', d:'Error.'},
    {id:'s33', n:'Matrix', p:200000, c:'#000', e:'matrix', d:'Binario.'},
    {id:'s34', n:'Disco', p:250000, c:'rainbow', e:'disco', d:'Fiesta.'},
    {id:'s35', n:'Arco√≠ris', p:300000, c:'rainbow', e:'rainbow_trail', d:'Infinito.'},
    {id:'s36', n:'Invisible', p:350000, c:'rgba(255,255,255,0.2)', e:'outline', d:'Contorno.'},
    {id:'s37', n:'Plata', p:400000, c:'#CFD8DC', e:'shiny', d:'Plata.'},
    {id:'s38', n:'Oro', p:500000, c:'#FFD700', e:'gold_spark', d:'Oro.'},
    {id:'s39', n:'Rub√≠', p:600000, c:'#D50000', e:'gem', d:'Rub√≠.'},
    {id:'s40', n:'Diamante', p:700000, c:'#E0F7FA', e:'shine_blue', d:'Diamante.'},
    {id:'s41', n:'Galaxia', p:800000, c:'#311B92', e:'stars', d:'Universo.'},
    {id:'s42', n:'Sol', p:900000, c:'#FF6D00', e:'sun', d:'Solar.'},
    {id:'s43', n:'Luna', p:1000000, c:'#90A4AE', e:'moon', d:'Lunar.'},
    {id:'s44', n:'Alien', p:1200000, c:'#64DD17', e:'ufo', d:'Ovni.'},
    {id:'s45', n:'Drag√≥n', p:1500000, c:'#B71C1C', e:'scale', d:'Escamas.'},
    {id:'s46', n:'Vampiro', p:2000000, c:'#212121', e:'bat', d:'Murci√©lagos.'},
    {id:'s47', n:'√Ångel', p:3000000, c:'#fff', e:'halo', d:'Celestial.'},
    {id:'s48', n:'Demonio', p:5000000, c:'#D50000', e:'hell', d:'Infernal.'},
    {id:'s49', n:'Ciberpunk', p:7500000, c:'#FFEA00', e:'cyber', d:'Futuro.'},
    {id:'s50', n:'REY', p:10000000, c:'#FFD700', e:'crown', d:'El Rey.'}
];

const FX = {
    particles: [],
    add(x, y, type, color) {
        const p = { x, y, type, life: 1, c: color || '#fff' };
        if(type.includes('fire')) { p.vx=(Math.random()-0.5); p.vy=-1-Math.random(); p.decay=0.05; p.s=Math.random()*8+4; }
        else if(type.includes('trail')) { p.vx=0; p.vy=0; p.decay=0.02; p.s=Math.random()*6+2; }
        else if(type==='sparkle' || type==='gold_spark') { p.vx=(Math.random()-0.5); p.vy=(Math.random()-0.5); p.decay=0.05; p.s=Math.random()*4; p.rot=Math.random(); }
        else if(type==='ice_shard') { p.vx=(Math.random()-0.5); p.vy=1; p.decay=0.03; p.s=Math.random()*5+2; p.rot=Math.random()*360; }
        else if(type==='zap') { p.vx=(Math.random()-0.5)*4; p.vy=(Math.random()-0.5)*4; p.decay=0.2; p.s=2; }
        else { p.vx=(Math.random()-0.5); p.vy=(Math.random()-0.5); p.decay=0.03; p.s=4; }
        this.particles.push(p);
    },
    update() { this.particles.forEach(p => { p.x += p.vx || 0; p.y += p.vy || 0; p.life -= p.decay; if(p.type.includes('spark')) p.rot+=0.2; }); this.particles = this.particles.filter(p => p.life > 0); },
    draw(ctx) {
        this.particles.forEach(p => {
            ctx.globalAlpha = p.life; ctx.fillStyle = p.c;
            if(p.type.includes('fire')) { ctx.beginPath(); ctx.arc(p.x, p.y, p.s, 0, Math.PI*2); ctx.fill(); } 
            else if(p.type.includes('spark')) { ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot); ctx.fillRect(-p.s/2,-p.s/2,p.s,p.s); ctx.restore(); } 
            else if(p.type==='ice_shard') { ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot); ctx.fillStyle='#E0F7FA'; ctx.fillRect(-p.s/2,-p.s/2,p.s,p.s); ctx.restore(); } 
            else { ctx.beginPath(); ctx.arc(p.x, p.y, p.s, 0, Math.PI*2); ctx.fill(); }
        }); ctx.globalAlpha = 1;
    }
};

const R = (m) => Math.floor(Math.random()*m);
const GRID = 18; let TILE = 25;
const canvas = document.getElementById('gc'), ctx = canvas.getContext('2d');
const pCanvas = document.getElementById('preview-canvas'), pCtx = pCanvas.getContext('2d');

const Game = {
    state: 'LOAD', data: { bank: 0, inventory: ['s1'], equipped: 's1', maxLevel: 1 },
    snake: [], dir: {x:0,y:-1}, nextDir: {x:0,y:-1}, food: null, score: 0, level: 1, eaten: 0,
    obstacles: [], speed: 160, lastT: 0, time: 0, wobble: 0,

    init() {
        setTimeout(()=>{ document.getElementById('screen-loading').classList.add('hidden'); this.showScreen('screen-menu'); this.state='MENU'; this.resize(); }, 1000);
        try{ const s = localStorage.getItem('snake_1000_v1'); if(s) this.data={...this.data, ...JSON.parse(s)}; }catch(e){}
        this.bindInput(); this.updateUI(); window.addEventListener('resize',()=>this.resize());
        requestAnimationFrame(t=>this.loop(t));
    },
    resize() { const s = Math.min(window.innerWidth-20, window.innerHeight*0.6, 500); canvas.width=canvas.height=s; TILE = s/GRID; },
    save() { localStorage.setItem('snake_1000_v1', JSON.stringify(this.data)); this.updateUI(); },
    
    startRun(l) { audioSys.play('click'); this.level=l; this.score=0; Env.set(this.level); this.startLvl(); this.showScreen(null); this.state='PLAY'; this.lastT=performance.now(); },
    startLvl() {
        this.snake=[{x:9,y:12},{x:9,y:13},{x:9,y:14}]; this.dir={x:0,y:-1}; this.nextDir={x:0,y:-1}; this.eaten=0;
        this.speed = Math.max(50, 160 - (this.level*1.5)); FX.particles=[];
        this.genObstacles(); this.spawnFood(); this.updateUI();
    },
    genObstacles() {
        this.obstacles=[]; 
        if(this.level < 2) return;
        const count = Math.min(70, 3 + Math.floor(this.level / 2));
        if(this.level > 50 && this.level % 10 === 0) {
            for(let i=4; i<14; i++) { this.obstacles.push({x:i,y:9}); this.obstacles.push({x:9,y:i}); }
        }
        for(let i=0; i<count; i++) {
            let o, safe=false;
            while(!safe) {
                o={x:R(GRID),y:R(GRID)}; 
                if(Math.abs(o.x-9)>3 || Math.abs(o.y-12)>3) { 
                    if(!this.obstacles.some(obs=>obs.x==o.x && obs.y==o.y)) safe=true;
                }
            }
            this.obstacles.push(o);
        }
    },
    spawnFood() { let a=0; do{this.food={x:R(GRID),y:R(GRID)}; a++}while(this.isCol(this.food.x,this.food.y) && a<100); if(a>=100) this.food={x:0,y:0}; },
    isCol(x,y) { return x<0||x>=GRID||y<0||y>=GRID||this.snake.some(s=>s.x==x&&s.y==y)||this.obstacles.some(o=>o.x==x&&o.y==y); },
    input(x,y) { if(this.state=='PLAY' && (this.dir.x+x!=0 || this.dir.y+y!=0)) this.nextDir={x,y}; },

    update(t) {
        this.time = t; this.wobble += 0.15; FX.update();
        if(t - this.lastT < this.speed) return;
        this.lastT = t; this.dir = this.nextDir;
        const head = {x:this.snake[0].x+this.dir.x, y:this.snake[0].y+this.dir.y};
        if(this.isCol(head.x, head.y)) return this.gameOver();
        this.snake.unshift(head);

        let skin = SKINS.find(s=>s.id===this.data.equipped);
        if(!skin) { skin=SKINS[0]; this.data.equipped='s1'; } 

        if(skin.id !== 's1') {
            const tail = this.snake[this.snake.length-1];
            const tx = tail.x*TILE+TILE/2, ty = tail.y*TILE+TILE/2;
            if(skin.e.includes('trail')) FX.add(tx, ty, 'trail', skin.c);
            if(skin.e.includes('fire')) FX.add(tx, ty, 'fire', '#FF5722');
            if(skin.e.includes('ice')) FX.add(tx, ty, 'ice_shard', '#fff');
            if(skin.e.includes('spark')) FX.add(tx, ty, 'sparkle', '#FFD700');
        }

        if(head.x==this.food.x && head.y==this.food.y) {
            audioSys.play('eat'); this.score+=10 + this.level; this.eaten++;
            for(let i=0;i<8;i++) FX.add(head.x*TILE+TILE/2, head.y*TILE+TILE/2, 'trail', `hsl(${R(360)},80%,50%)`);
            if(this.eaten>=5){ 
                this.level++; 
                if(this.level > this.data.maxLevel) this.data.maxLevel = this.level;
                this.data.bank+=this.score; this.save(); 
                document.body.style.background = '#fff';
                setTimeout(() => Env.set(this.level), 100);
                this.startLvl(); 
            } else { this.spawnFood(); this.updateUI(); }
        } else { this.snake.pop(); }
    },

    draw() {
        let skin = SKINS.find(s=>s.id===this.data.equipped);
        if(!skin) skin=SKINS[0];
        this.drawGame(ctx, canvas, skin, this.snake, this.food, this.obstacles, false);
    },

    drawGame(ctx, cvs, skin, snake, food, obstacles, isPreview) {
        ctx.clearRect(0,0,cvs.width,cvs.height);
        
        ctx.save();
        if(!isPreview) Env.applyFrameEffect(ctx, cvs.width, cvs.height, this.time);

        const TS = cvs.width / (isPreview ? 10 : GRID);
        
        if(!isPreview) FX.draw(ctx); 

        if(obstacles) obstacles.forEach(o=>{
            let x=o.x*TS, y=o.y*TS, s=TS-2;
            ctx.fillStyle='#795548'; ctx.strokeStyle='#3E2723'; ctx.lineWidth=3;
            ctx.fillRect(x,y,s,s); ctx.strokeRect(x,y,s,s);
            ctx.beginPath(); ctx.moveTo(x,y); ctx.lineTo(x+s,y+s); ctx.stroke(); ctx.beginPath(); ctx.moveTo(x+s,y); ctx.lineTo(x,y+s); ctx.stroke();
        });

        if(food) {
            const fx=food.x*TS+TS/2, fy=food.y*TS+TS/2 + Math.sin(this.wobble)*5;
            ctx.fillStyle='#FF1744'; ctx.strokeStyle='#212121'; ctx.lineWidth=2;
            ctx.beginPath(); ctx.arc(fx, fy, TS/2-2, 0, Math.PI*2); ctx.fill(); ctx.stroke();
            ctx.fillStyle='#76FF03'; ctx.beginPath(); ctx.ellipse(fx+2,fy-8,5,2,0.5,0,Math.PI*2); ctx.fill(); ctx.stroke();
        }

        if(skin.e==='neon' || skin.e.includes('glow')) { ctx.shadowBlur=15; ctx.shadowColor=skin.c; }
        if(skin.e==='ghost') ctx.globalAlpha=0.6;
        if(skin.e==='outline') { ctx.lineWidth=1; ctx.strokeStyle='#263238'; } else ctx.strokeStyle='#263238';

        snake.forEach((s, i) => {
            const x = s.x*TS + TS/2, y = s.y*TS + TS/2;
            let r = TS/2; if(i>0 && skin.e!=='pixel') r -= Math.sin(this.wobble+i)*1.5;
            let color = skin.c;
            if(skin.c==='rainbow') color=`hsl(${(i*25+this.time/2)%360}, 100%, 60%)`;
            if(skin.e==='glitch' && Math.random()>0.9) ctx.translate(R(4)-2, R(4)-2);
            
            ctx.fillStyle = color; ctx.lineWidth = 2;
            
            if(skin.e==='pixel') { ctx.fillRect(s.x*TS+1, s.y*TS+1, TS-2, TS-2); ctx.strokeRect(s.x*TS+1, s.y*TS+1, TS-2, TS-2); }
            else { ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill(); ctx.stroke(); }

            if(skin.e.includes('stripe')) { ctx.fillStyle='#000'; ctx.beginPath(); ctx.arc(x,y,r/2,0,Math.PI*2); ctx.fill(); }
            if(skin.e.includes('spot')) { ctx.fillStyle='#000'; ctx.beginPath(); ctx.arc(x+3,y-3,3,0,Math.PI*2); ctx.fill(); }
            if(skin.e==='shiny' || skin.e==='gold_spark') { ctx.fillStyle='rgba(255,255,255,0.6)'; ctx.beginPath(); ctx.arc(x-3,y-3,4,0,Math.PI*2); ctx.fill(); }

            if(i===0) { 
                ctx.shadowBlur=0; ctx.setTransform(1,0,0,1,0,0);
                if(!isPreview) Env.applyFrameEffect(ctx, cvs.width, cvs.height, this.time);

                if(skin.e!=='matrix') {
                    ctx.fillStyle='#fff';
                    const blink = Math.sin(this.time/200)>0.9 ? 0.1 : 1;
                    ctx.save(); ctx.translate(x,y); ctx.scale(1, blink);
                    ctx.beginPath(); ctx.arc(-5,-5,5,0,Math.PI*2); ctx.fill(); ctx.stroke();
                    ctx.beginPath(); ctx.arc(5,-5,5,0,Math.PI*2); ctx.fill(); ctx.stroke();
                    ctx.fillStyle='#000';
                    ctx.beginPath(); ctx.arc(-5,-5,2,0,Math.PI*2); ctx.fill();
                    ctx.beginPath(); ctx.arc(5,-5,2,0,Math.PI*2); ctx.fill();
                    if(skin.e==='crown') { ctx.fillStyle='#FFD700'; ctx.strokeStyle='#000'; ctx.beginPath(); ctx.moveTo(-8,-12); ctx.lineTo(-4,-20); ctx.lineTo(0,-14); ctx.lineTo(4,-20); ctx.lineTo(8,-12); ctx.fill(); ctx.stroke(); }
                    ctx.restore();
                }
            }
        });
        
        ctx.restore(); ctx.shadowBlur=0; ctx.globalAlpha=1; 
    },

    loop(t) { if(this.state==='PLAY') { this.update(t); this.draw(); } requestAnimationFrame(tm=>this.loop(tm)); },
    
    /* MODIFIED GAME OVER TO CHECK FOR ADS */
    gameOver() { 
        audioSys.play('die'); 
        this.data.bank+=this.score; 
        document.getElementById('over-earnings').innerText=this.score; 
        this.save(); 
        
        // Check AD
        if(Ads.check()) {
            this.state = 'AD';
        } else {
            this.state='OVER'; 
            this.showScreen('screen-over'); 
        }
    },

    updateUI() { document.getElementById('hud-score').innerText=this.score; document.getElementById('hud-level').innerText=this.level; document.getElementById('hud-bank').innerText=this.data.bank+this.score; document.getElementById('hud-prog').style.width=Math.min(100, (this.eaten/5)*100)+'%'; document.getElementById('menu-money').innerText=this.data.bank; },
    togglePause() { audioSys.play('click'); if(this.state==='PLAY'){ this.state='PAUSE'; this.showScreen('screen-pause'); } else if(this.state==='PAUSE') this.resume(); },
    resume() { audioSys.play('click'); this.state='PLAY'; this.showScreen(null); this.lastT=performance.now(); },
    restartLevel() { this.startRun(this.level); },
    toMenu() { audioSys.play('click'); this.save(); this.state='MENU'; this.showScreen('screen-menu'); },
    showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden')); if(id) { document.getElementById(id).classList.remove('hidden'); document.getElementById(id).style.display='flex'; } },
    bindInput() { document.addEventListener('keydown', e => { if(e.key==='Escape')this.togglePause(); if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key))e.preventDefault(); if(this.state==='PLAY'){ if(e.key==='ArrowUp')this.input(0,-1); if(e.key==='ArrowDown')this.input(0,1); if(e.key==='ArrowLeft')this.input(-1,0); if(e.key==='ArrowRight')this.input(1,0); } }); }
};

const Map = {
    open() {
        audioSys.play('click');
        const c = document.getElementById('map-container'); c.innerHTML='';
        for(let i=1; i<=1000; i++) {
            const locked = i > Game.data.maxLevel;
            const btn = document.createElement('div');
            btn.className = `level-btn ${locked ? 'locked' : ''} ${i===Game.data.maxLevel ? 'current' : ''}`;
            btn.innerHTML = locked ? 'üîí' : i;
            if(!locked) btn.onclick = () => { Game.startRun(i); };
            c.appendChild(btn);
        }
        Game.showScreen('screen-map');
    }
};

const Shop = {
    skin: null, loopId: null, pSnake: [], pParticles: [],
    open() {
        audioSys.play('click'); const c = document.getElementById('shop-container'); c.innerHTML='';
        SKINS.forEach(s => {
            const owned = Game.data.inventory.includes(s.id), equipped = Game.data.equipped === s.id;
            const el = document.createElement('div'); el.className = `skin-card ${owned?'owned':''}`; el.onclick = () => this.preview(s);
            let bg = s.c; if(s.c=='rainbow') bg='linear-gradient(45deg, red, orange, green, blue)';
            el.innerHTML = `<div class="skin-preview-icon" style="background:${bg}"></div><div style="font-weight:bold;font-size:0.8rem;text-align:center">${s.n}</div><div class="skin-badge">TUYO</div><div style="font-size:0.7rem;color:#aaa;margin-top:auto">${owned?(equipped?'EN USO':'VER'):'$'+s.p}</div>`;
            c.appendChild(el);
        });
        Game.showScreen('screen-shop');
    },
    preview(s) {
        audioSys.play('click'); this.skin = s;
        document.getElementById('preview-overlay').classList.remove('hidden');
        document.getElementById('prev-name').innerText = s.n; document.getElementById('prev-desc').innerText = s.d; document.getElementById('prev-price').innerText = Game.data.inventory.includes(s.id) ? "ADQUIRIDO" : "$"+s.p;
        const btn = document.getElementById('btn-buy-action');
        if(Game.data.inventory.includes(s.id)) { btn.innerText="EQUIPAR"; btn.onclick=()=>this.equip(); } else { btn.innerText="COMPRAR"; btn.onclick=()=>this.buy(); }
        this.pSnake=[]; for(let i=0;i<8;i++) this.pSnake.push({x:5,y:5});
        this.pParticles=[]; 
        if(this.loopId) cancelAnimationFrame(this.loopId); this.loop();
    },
    loop() {
        const t = performance.now()/500; const h = {x: 5+Math.sin(t)*3, y: 5+Math.cos(t*2)*3};
        for(let i=this.pSnake.length-1; i>0; i--) { this.pSnake[i].x=this.pSnake[i-1].x; this.pSnake[i].y=this.pSnake[i-1].y; }
        this.pSnake[0] = h;
        Game.drawGame(pCtx, pCanvas, this.skin, this.pSnake, null, null, true);
        // Preview FX
        if(this.skin.id !== 's1' && Math.random()>0.8) {
            const tx=this.pSnake[7].x*25+12.5, ty=this.pSnake[7].y*25+12.5; 
            const p = { x:tx, y:ty, life:1, c:this.skin.c, type:'trail', s:4 };
            if(this.skin.e.includes('fire')) { p.type='fire'; p.vy=-1; p.c='#FF5722'; p.s=6; }
            if(this.skin.e.includes('ice')) { p.type='ice_shard'; p.vy=1; p.c='#fff'; p.s=4; }
            if(this.skin.e.includes('spark')) { p.type='sparkle'; p.c='#FFD700'; p.s=3; }
            this.pParticles.push(p);
        }
        this.pParticles.forEach(p=>{ 
            p.life-=0.05; if(p.type==='fire')p.y+=p.vy; 
            pCtx.globalAlpha=p.life; pCtx.fillStyle=p.c; 
            pCtx.beginPath(); pCtx.arc(p.x,p.y,p.s,0,Math.PI*2); pCtx.fill();
        });
        this.pParticles=this.pParticles.filter(p=>p.life>0);
        pCtx.globalAlpha=1;
        this.loopId = requestAnimationFrame(()=>this.loop());
    },
    closePreview() { document.getElementById('preview-overlay').classList.add('hidden'); cancelAnimationFrame(this.loopId); },
    buy() { if(Game.data.bank>=this.skin.p){ audioSys.play('eat'); Game.data.bank-=this.skin.p; Game.data.inventory.push(this.skin.id); Game.save(); this.preview(this.skin); this.open(); } },
    equip() { audioSys.play('click'); Game.data.equipped=this.skin.id; Game.save(); this.closePreview(); this.open(); },
    close() { Game.toMenu(); }
};

window.game = Game; window.shop = Shop; window.map = Map; window.FX = FX; window.Env = Env;
window.onload = () => Game.init();
</script>
</body>
</html>
